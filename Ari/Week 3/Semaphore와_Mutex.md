# Semaphore/Mutex

## Semaphore

공유된 자원의 데이터 혹은 임계 구역(critical section)등에 여러 프로세스 혹은 스레드가 접근하는 것을 막아준다. </br>
즉, 공유 자원에 접근할 수 있는 스레드의 수를 제어해주는 역할을 한다.

공유된 자원에 여러 프로세스가 동시에 접근하면서 문제가 발생할 수가 있는데, 이때 공유된 자원의 데이터는 한번에 하나의 프로세스만 접근할 수 있도록 제한을 둬야 한다. </br>
이를 위해 나온 것이 바로 세마포어인 것이다.

* 임계 구역(Critical Section)
  * 여러 프로세스가 데이터를 공유하며 수행될 때, 각 프로세스에서 공유 데이터를 접근하는 프로그램 코드 부분을 말한다.
  * 공유 데이터를 여러 프로세스가 동시에 접근할 때 잘못된 결과를 만들 수 있기 때문에 한 프로세스가 임계 구역을 수행할 때는 다른 프로세스가 접근하지 못하도록 해야한다.

![image](https://user-images.githubusercontent.com/75905803/205791374-8738bc89-6894-4453-8255-7686e456fe22.png)

* 세마포어 P, V 연산
  * P
    * 임계 구역에 들어가기 전에 수행 (프로세스 진입 여부를 자원의 개수(S)를 통해 결정
  * V
    * 임계 구역에서 나올 때 수행 (자원 반납 알림, 대기 중인 프로세스를 깨우는 신호)

세마포어 연산은 다음과 같이 정의한다.

* `P(S)`
    * 세마포어 변수 S를 무조건 1 줄이고, 그 변수의 값이 음수면 해당 프로세스를 Wait Queue로 보낸 후 Block 상태로 만든다.

```	c
// P(S)
S.value--;
if (S.value < 0)
{
    add this process to S.L;
    block();
}
```

* `V(S)`
    * 세마포어 변수 S를 무조건 1 늘리고, 그 변수의 값이 0보다 작거나 같으면 이미 기다리고 있는 프로세스가 있으므로 프로세스 P를 Wait Queue에서 꺼내서 Ready Queue로 보낸다.
    * 세마포어 변수 S값이 양수면 아무나 임계 구역에 들어갈 수 있으므로 별다른 추가 연산을 하지 않는다.
    * V 연산은 특정 프로세스가 공유 데이터를 반납한 후 임계 구역에서 나가는 연산임을 기억해야 한다.

> 나 이제 임계 구역에서 나갈거니까 기다리는 친구 있으면 임계 구역에 들어가라~

```c
// V(S)
S.value++;
if (S.value <= 0)
{
    remove a process P from S.L;
    wakeup(P);
}
```

</br>
</br>

## Mutex

임계 구역을 가진 스레드들의 실행시간이 서로 겹치지 않고 각각 단독으로 실행되게 하는 기술을 의미한다.

> 상호 배제(**Mut**ual **Ex**clustion)의 약자

해당 접근을 조율하기 위해 lock과 unlock을 사용한다.

* lock
  * 현재 임계 구역에 들어갈 권한을 얻어온다.
  * 만약 다른 프로세스/스레드가 임계 구역 수행중이면 종료할 때까지 대기한다.
* unlock
  * 현재 임계 구역을 모두 사용했음을 알린다.
  * 대기 중인 다른 프로세스/스레드가 임계 구역에 진입할 수 있다.

> 뮤텍스는 상태가 0, 1로 이진 세마포어로 부르기도 한다.


## 뮤텍스와 세마포어의 차이점

* 동기화 대상의 갯수
    * 뮤텍스는 동기화 대상이 only 1개일 때 사용한다.
    * 세마포어는 동기화 대상이 1개 이상일 때 사용한다.
* 세마포어는 뮤텍스가 될 수 있지만, 뮤텍스는 세마포어가 될 수 없다.
    * 뮤텍스는 0, 1로 이루어진 이진 상태이므로 Binary Semaphore
* 뮤텍스는 자원 소유 가능 + 책임을 가지는 반면, 세마포어는 자원 소유 불가
    * 뮤텍스는 상태 0, 1 뿐이므로 Lock을 가질 수 있다.
* 뮤텍스는 소유하고 있는 스레드만이 이 뮤텍스를 해제할 수 있다.
    * 반면 세마포어는 세마포어를 소유하지 않는 스레드가 세마포어를 해제할 수 있다.
* 세마포어는 시스템 범위에 걸쳐있고, 파일 시스템 상의 파일로 존재한다.
    * 반면 뮤텍스는 프로세스의 범위를 가지며 프로세스 종료될 때 자동으로 Clean up 된다.


뮤텍스와 세마포어는 모두 완벽한 기법은 아니므로 데이터 무결성을 보장할 수 없으며, 모든 교착 상태를 해결하지는 못한다.
하지만 상호배제를 위한 기본적인 기법이며 여기에 좀 더 복잡한 매커니즘을 적용해 개선된 성능을 가질 수 있도록 하는 것이 중요하다.
